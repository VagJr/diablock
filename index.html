<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>DIABLOCK - V34 Infernal Ascension</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
@import url('https://fonts.googleapis.com/css2?family=Courier+New&display=swap');
html,body{ margin:0; width:100%; height:100%; background:#050000; overflow:hidden; font-family:'Courier New', monospace; user-select:none; color:#c00; touch-action: none; }
canvas{ width:100%; height:100%; image-rendering:pixelated; cursor: crosshair; display:block; touch-action: none;}
.scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 2px 100%; z-index: 999; }
#ui-layer{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }

/* BRANDING FINAL: INFERNAL THEME */
.hud-bottom{ position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; align-items:center; }
.bar-box{ width:300px; padding:5px 10px; background:rgba(20,0,0,0.9); border:2px solid #500; margin-bottom:5px; box-shadow: 0 0 15px #500; }
.bar-status-text{ display:flex; justify-content:space-between; font-size:12px; color:#fff; margin-bottom:2px; font-weight:bold; text-shadow: 1px 1px 0 #000; }
.bar-container{ width:100%; height:8px; background:#111; margin-bottom:4px; border:1px solid #300; position:relative; }
.bar-container.xp { height: 4px; }
.fill{ height:100%; transition:width 0.1s; }
.fill.hp{ background:#a00; box-shadow: 0 0 5px #f00; } .fill.mp{ background:#00a; } .fill.xp{ background:#fa0; }

.skills{ display:flex; gap:5px; pointer-events:auto; align-items: flex-end; }
.skill-btn{ width:36px; height:36px; background:#100; border:2px solid #600; color:#f00; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold; cursor:pointer; position: relative;}
.skill-btn:hover { background: #300; color:#fff; border-color: #f00; }
.key-hint { position: absolute; top:-12px; font-size: 8px; color: #aaa; }

/* Panels */
.panel{ display:none; position:absolute; background:#050000; border:2px solid #500; padding:10px; pointer-events:auto; color:#a00; box-shadow: 5px 5px 0px #200; }
#inventory{ top:50%; left:65%; transform:translate(-50%, -50%); width:280px; }
#craft-panel{ top:50%; left:35%; transform:translate(-50%, -50%); width:220px; border-color:#606; color:#a0a; box-shadow: 5px 5px 0px #303; }
#char-panel{ top:50%; left:20%; transform:translate(-50%, -50%); width:200px; border-color: #880; color: #cc0; }
#shop-panel{ top:40%; left:50%; transform:translate(-50%, -50%); width:300px; border-color:#088; color:#0cc; }

/* PHASE 1: CHECKPOINT PORTAL */
#entry-modal{ top:50%; left:50%; transform:translate(-50%, -50%); width:300px; text-align:center; border-color:#f00; color:#f00; box-shadow: 0 0 20px #500; z-index: 1000; background: #100; }
.checkpoint-list { max-height: 150px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #300; background: #000; padding: 5px; }
.checkpoint-btn { display: block; width: 100%; padding: 5px; background: #200; color: #a00; border: 1px solid #500; margin-bottom: 2px; cursor: pointer; text-align: left; }
.checkpoint-btn:hover { background: #500; color: #fff; }

.grid{ display:grid; grid-template-columns:repeat(8, 1fr); gap:4px; margin-top:10px; }
.slot{ width:28px; height:28px; background:#100; border:1px solid #400; cursor:pointer; position:relative; }
.slot:hover{ background:#300; border-color: #f00; }
.stat-row{ display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; }
.plus-btn{ background:#200; border:1px solid #500; color:#f00; width:16px; height:16px; line-height:14px; text-align:center; cursor:pointer; font-size:12px; }
.plus-btn:hover{ background:#f00; color:#000; }
#tooltip { position: absolute; background: #100; border: 1px solid #f00; padding: 5px; z-index: 1000; display: none; pointer-events: none; font-size: 10px; color:#fff; white-space:nowrap; box-shadow: 0 0 10px #f00; }
.equip-slots { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }

#menu{ position:absolute; top:0; left:0; width:100%; height:100%; background:#050000; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; z-index:10; }
.btn{ padding:10px 20px; background:#200; color:#f00; border:2px solid #500; margin:5px; cursor:pointer; font-family:inherit; font-weight:bold;}
.btn:hover{ background:#f00; color:#000; box-shadow: 0 0 10px #f00; }
.craft-item { padding: 5px; border-bottom: 1px solid #303; cursor:pointer; }
.craft-item:hover { background: #303; color: #fff; }
input, select{ padding:10px; background:#100; border:2px solid #500; color:#f00; margin:5px; font-family:inherit;}
h1 { text-shadow: 2px 2px #500; color: #f00; letter-spacing: 5px; }
#hud-gold { position: absolute; top: 10px; left: 10px; font-size: 18px; color: #fb0; font-weight: bold; text-shadow: 1px 1px #000; }

#chat-container { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); width: 300px; display: none; pointer-events: auto; }
#chat-input { width: 100%; background: rgba(0,0,0,0.8); border: 1px solid #0f0; color: #fff; padding: 5px; font-family: inherit; }

#game-log-container {
    position: absolute; top: 10px; right: 10px; width: 280px; height: 180px;
    background: rgba(10, 0, 0, 0.85); border: 1px solid #500;
    padding: 8px; pointer-events: none; overflow-y: hidden; font-size: 11px; z-index: 20;
}
#game-log { display: flex; flex-direction: column-reverse; gap: 4px; height: 100%; overflow-y: scroll; }
#game-log::-webkit-scrollbar { width: 4px; }
#game-log::-webkit-scrollbar-thumb { background: #500; border-radius: 2px; }

/* MOBILE CONTROLS */
#mobile-controls { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 120px; pointer-events: none; z-index: 5; }
#joystick-area { position: absolute; bottom: 10px; left: 15px; width: 120px; height: 120px; pointer-events: auto; border-radius: 50%; z-index: 1; }
#joystick-base { position: absolute; left: 15px; bottom: 10px; width: 100px; height: 100px; border: 2px solid rgba(255, 0, 0, 0.5); background: rgba(20, 0, 0, 0.4); border-radius: 50%; pointer-events: none; z-index: 0; transform: translate(10px, 10px); }
#joystick-knob { position: absolute; width: 40px; height: 40px; background: rgba(255, 0, 0, 0.7); border: 1px solid #f00; border-radius: 50%; pointer-events: none; z-index: 1; transition: transform 0.05s ease-out; }

#action-container { right: 15px; width: 160px; height: 110px; bottom: 0px; position: absolute; pointer-events: auto; }
.action-btn { position: absolute; width: 45px; height: 45px; border-radius: 50%; background: rgba(30, 0, 0, 0.8); border: 2px solid; color: #f00; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); z-index: 2; }

#btn-atk { width: 55px; height: 55px; font-size: 16px; bottom: 0px; right: 0px; border-color: #f00; color: #f00; } 
#btn-skill { width: 45px; height: 45px; font-size: 12px; border-color: #0ff; color: #0ff; bottom: 55px; right: 55px; } 
#btn-dash { width: 45px; height: 45px; font-size: 12px; border-color: #fff; color: #fff; bottom: 0px; right: 60px; } 
#btn-potion { width: 45px; height: 45px; font-size: 10px; border-color: #f33; color: #f33; bottom: 60px; right: 0px; }
#btn-block { width: 45px; height: 45px; font-size: 12px; border-color: #0f0; color: #0f0; bottom: 60px; right: 110px; }

#mobile-menu-buttons { position: absolute; bottom: 115px; right: 5px; display: flex; gap: 5px; pointer-events: auto; z-index: 10; }
#mobile-menu-buttons .skill-btn { width: 38px; height: 38px; background: rgba(30,0,0,0.8); font-size: 10px; border-radius: 5px; border-color: #500; color: #f00; }

#hud-horizontal-mobile { position: absolute; top: 0px; left: 0px; width: 100%; height: 20px; background: rgba(10, 0, 0, 0.9); border-bottom: 1px solid #500; pointer-events: none; display: none; justify-content: space-between; align-items: center; padding: 0 5px; box-sizing: border-box; font-size: 9px; z-index: 5; }
.h-bar-container { width: 60px; height: 5px; background: #111; border: 1px solid #300; position: relative; display: inline-block; vertical-align: middle; margin-right: 5px; }

@media (max-width: 1024px) { 
    .hud-bottom { display: none !important; } 
    #hud-gold { display: none !important; } 
    #game-log-container { display: block !important; top: 25px; left: 50%; transform: translateX(-50%); width: 250px; height: 80px; background: rgba(0,0,0,0.5); border: none; right: auto; }
}
@media (max-width: 768px) and (orientation: landscape) { #mobile-menu-buttons { top: 0; bottom: auto; right: 5px; } }

.ui-action-buttons { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); display: none; gap: 15px; pointer-events: auto; z-index: 100; }
.ui-action-buttons .btn { padding: 8px 12px; font-size: 14px; border-radius: 5px; border: 2px solid #fff; background: rgba(50,0,0,0.8); color: #fff; cursor: pointer; }
.ui-action-buttons .btn:hover { background: #f00; color: #000; }

</style>
</head>
<body oncontextmenu="return false">
<canvas id="c"></canvas>
<div class="scanlines"></div>
<div id="tooltip"></div>

<div id="ui-layer">
    <div id="hud-gold">GOLD: 0</div>
    <div id="game-log-container"><div id="game-log"></div></div>

    <div id="hud-horizontal-mobile">
        <span id="h-lvl-txt" style="color:#f00;">NORMAL [1]</span>
        <div style="flex-grow: 1; text-align: center;">
            <span id="h-gold-txt" style="color:#fb0;">0G</span>
        </div>
        <div>
            <span style="color:#f00; font-weight: bold;">HP</span>
            <div class="h-bar-container"><div class="fill hp" id="h-hp-bar"></div></div>
        </div>
        <div>
            <span style="color:#00f; font-weight: bold;">MP</span>
            <div class="h-bar-container"><div class="fill mp" id="h-mp-bar"></div></div>
        </div>
    </div>
    
    <div id="chat-container"><input type="text" id="chat-input" placeholder="Say something..." maxlength="30"></div>
    
    <div class="hud-bottom">
        <div class="bar-box">
            <div class="bar-status-text">
                <span id="lvl-txt">NORMAL [1]</span>
                <span id="hp-txt">HP: 100/100</span>
            </div>
            <div class="bar-container hp"><div class="fill hp" id="hp-bar"></div></div>
            
            <div class="bar-status-text" style="color:#0ff;">
                <span>MANA</span>
                <span id="mp-txt">MP: 50/50</span>
            </div>
            <div class="bar-container mp"><div class="fill mp" id="mp-bar"></div></div>
            
            <div class="bar-status-text" style="color:#fb0;">
                <span>EXP</span>
                <span id="xp-txt">0%</span>
            </div>
            <div class="bar-container xp"><div class="fill xp" id="xp-bar"></div></div>
        </div>
        <div class="skills">
            <div class="skill-btn" onclick="socket.emit('attack', getAttackAngle())">ATK</div>
            <div class="skill-btn" id="skill-1" onclick="socket.emit('skill', {angle: getAttackAngle()})"><span class="key-hint">E</span>SKL</div>
            <div class="skill-btn" id="skill-dash" onclick="socket.emit('dash', getDashAngle())"><span class="key-hint">SPC</span>DSH</div>
            <div class="skill-btn" id="hud-potion" onclick="socket.emit('potion')"><span class="key-hint">E</span>POT</div>
            <div class="skill-btn" onclick="toggleUI('inv')"><span class="key-hint">I</span>INV</div>
            <div class="skill-btn" onclick="toggleUI('craft')"><span class="key-hint">K</span>CFT</div>
            <div class="skill-btn" onclick="toggleUI('char')"><span class="key-hint">C</span>CHR</div>
        </div>
    </div>
    
    <div id="entry-modal" class="panel">
        <h3 style="margin-top:0; color:#f00; text-shadow: 0 0 5px #f00;">PORTAL INFERNAL</h3>
        <p style="font-size:11px; color:#aaa;">Selecione o nível da masmorra:</p>
        <div id="checkpoint-list" class="checkpoint-list">
            </div>
        <button class="btn" onclick="dungeonAction('coop')" style="width:100%; color:#0f0; border-color:#0f0;">MODO COOP (Online)</button>
        <br><br>
        <button class="btn" onclick="document.getElementById('entry-modal').style.display='none'" style="font-size:10px;">CANCELAR</button>
    </div>

    <div id="inventory" class="panel">
        <div style="text-align:center; border-bottom:1px dashed #f00; font-size:14px; padding-bottom:5px;">[ MOCHILA ]</div>
        <div class="grid" id="inv-grid"></div>
    </div>

    <div id="craft-panel" class="panel">
        <div style="text-align:center; border-bottom:1px dashed #f0f; font-size:14px; padding-bottom:5px;">[ FORJA ]</div>
        <div id="craft-list" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div id="shop-panel" class="panel">
        <div style="text-align:center; border-bottom:1px dashed #0ff; font-size:14px; padding-bottom:5px; margin-bottom: 10px;">[ MERCADOR ]</div>
        <div class="grid" id="shop-grid" style="grid-template-columns:repeat(5, 1fr);"></div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <button class="btn" style="border-color:#0ff; color:#0ff;" onclick="closeAllMenus()" id="btn-shop-close">FECHAR</button>
            <button class="btn" style="border-color:#f00; color:#f00;" onclick="window.sell()">VENDER INV</button>
        </div>
    </div>
    
    <div id="char-panel" class="panel">
        <div style="text-align:center; border-bottom:1px dashed #f00; font-size:14px; margin-bottom:10px;">[ ATRIBUTOS ]</div>
        <div class="equip-slots">
            <div class="slot" id="eq-head" title="Head"></div>
            <div class="slot" id="eq-body" title="Body"></div>
            <div class="slot" id="eq-hand" title="Hand"></div>
            <div class="slot" id="eq-rune" title="Rune"></div> 
            <div class="slot" id="eq-potion" title="Potion (E)"></div>
        </div>
        <div style="text-align:center; color:#fb0; margin-bottom:10px;">PTS: <span id="cp-pts">0</span></div>
        <div class="stat-row"><span>STR</span> <div><span id="val-str">5</span> <div class="plus-btn" id="btn-str" onclick="addStat('str')">+</div></div></div>
        <div class="stat-row"><span>DEX</span> <div><span id="val-dex">5</span> <div class="plus-btn" id="btn-dex" onclick="addStat('dex')">+</div></div></div>
        <div class="stat-row"><span>INT</span> <div><span id="val-int">5</span> <div class="plus-btn" id="btn-int" onclick="addStat('int')">+</div></div></div>
        <hr style="border:0; border-top:1px dashed #500">
        <div style="font-size:11px; color:#aaa;">DMG: <span id="stat-dmg">0</span> | SPD: <span id="stat-spd">0</span></div>
    </div>
</div>

<div class="ui-action-buttons" id="ui-action-buttons">
    <button class="btn" id="ui-btn-equip" onclick="handleGamepadAction()">EQUIPAR / USAR (A)</button>
    <button class="btn" id="ui-btn-drop" onclick="handleGamepadSecondaryAction()">DROPAR (B)</button>
</div>

<div id="mobile-controls">
    <div id="joystick-base"></div>
    <div id="joystick-knob" style="display:none;"></div>
    <div id="joystick-area" class="control-area"></div>
    <div id="action-container">
        <div id="btn-block" class="action-btn" data-action="block">BLK</div> 
        <div id="btn-potion" class="action-btn" data-action="potion">POT</div>
        <div id="btn-skill" class="action-btn" data-action="skill">SKL</div>
        <div id="btn-dash" class="action-btn" data-action="dash">DSH</div>
        <div id="btn-atk" class="action-btn" data-action="attack">ATK</div>
    </div>
</div>

<div id="mobile-menu-buttons">
    <div id="btn-inv-mobile" class="skill-btn" data-action="toggle_inv">INV</div>
    <div id="btn-char-mobile" class="skill-btn" data-action="toggle_char">CHR</div>
    <div id="btn-craft-mobile" class="skill-btn" data-action="toggle_craft">CFT</div>
    <div id="btn-chat-mobile" class="skill-btn" data-action="toggle_chat" style="border-color: #fff; color: #fff;">CHAT</div>
</div>

<div id="menu">
    <h1 style="font-size:50px; margin-bottom:0;">DIABLOCK</h1>
    <p style="color:#d00; margin-bottom:20px;">V34 - INFERNAL ASCENSION</p>
    <div id="login-form"><input type="text" id="username" placeholder="USER"><button class="btn" onclick="login()">LOGIN</button></div>
    <div id="char-select" style="display:none; text-align:center;">
        <div id="char-list" style="margin-bottom:20px;"></div>
        <input type="text" id="cname" placeholder="NAME">
        <select id="cclass"><option value="knight">WARRIOR</option><option value="hunter">RANGER</option><option value="mage">WIZARD</option></select>
        <button class="btn" onclick="create()">CREATE</button>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script src="/game.js"></script>
<script>
    // PHASE 1: CHECKPOINT LOGIC (CLIENT SIDE PORTAL)
    function dungeonAction(type) {
        socket.emit("dungeon_entry_choice", type);
        document.getElementById('entry-modal').style.display = 'none';
    }
    
    // Atualiza a lista de checkpoints quando o player interage com a escada (se estiver na cidade)
    // A lógica de exibição do modal está no game.js (socket.on 'u'), aqui apenas preenchemos a lista
    function updateCheckpointList(maxDepth) {
        const list = document.getElementById('checkpoint-list');
        list.innerHTML = "";
        
        // Add Safe Zone
        const btn0 = document.createElement("div");
        btn0.className = "checkpoint-btn";
        btn0.innerText = "Level 1 (Start)";
        btn0.onclick = () => dungeonAction(1);
        list.appendChild(btn0);

        // Add checkpoints every 5 levels up to maxDepth
        for (let i = 5; i <= maxDepth; i += 5) {
            const btn = document.createElement("div");
            btn.className = "checkpoint-btn";
            btn.innerText = `Level ${i} (Checkpoint)`;
            btn.onclick = () => dungeonAction(i);
            list.appendChild(btn);
        }
        
        // Add Max Depth
        if (maxDepth > 1 && maxDepth % 5 !== 0) {
            const btnMax = document.createElement("div");
            btnMax.className = "checkpoint-btn";
            btnMax.innerText = `Level ${maxDepth} (Deepest)`;
            btnMax.onclick = () => dungeonAction(maxDepth);
            list.appendChild(btnMax);
        }
    }

    function toggleUI(p) {
        uiState[p] = !uiState[p];
        updateUI();
    }
</script>
</body>
</html>